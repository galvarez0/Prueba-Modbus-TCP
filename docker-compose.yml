services:

  mosquitto:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z localhost 1883"]
      interval: 5s
      timeout: 3s
      retries: 5
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["modbus", "lorawan", "sim", "bridge", "obs"]

  modbus-server:
    build:
      context: ./server
      dockerfile: Dockerfile.server
    image: galvarez0/pruebatcp1:modbus-server
    ports:
      - "127.0.0.1:8080:8080"
    environment:
      - MQTT_BROKER=tcp://mosquitto:1883
    depends_on:
      mosquitto:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["modbus", "bridge"]

  modbus-client-1:
    image: galvarez0/pruebatcp1:modbus-client
    command: ["1"]
    restart: unless-stopped
    networks:
      - pruebatcp1
    profiles: ["modbus"]

  modbus-client-2:
    image: galvarez0/pruebatcp1:modbus-client
    command: ["2"]
    restart: unless-stopped
    networks:
      - pruebatcp1
    profiles: ["modbus"]

  chirpstack-postgresql:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_DB=chirpstack
      - POSTGRES_USER=chirpstack
      - POSTGRES_PASSWORD=chirpstack
    volumes:
      - ./chirpstack/configuration/postgresql/initdb:/docker-entrypoint-initdb.d:ro
      - chirpstack-postgresql-data:/var/lib/postgresql/data
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["lorawan", "sim", "bridge", "obs"]

  chirpstack-redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - chirpstack-redis-data:/data
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["lorawan", "sim", "bridge", "obs"]

  chirpstack:
    image: chirpstack/chirpstack:4
    restart: unless-stopped
    command: ["-c", "/etc/chirpstack"]
    volumes:
      - ./chirpstack/configuration/chirpstack:/etc/chirpstack:ro
    depends_on:
      chirpstack-postgresql:
        condition: service_started
      chirpstack-redis:
        condition: service_started
      mosquitto:
        condition: service_healthy
    ports:
      # UI / HTTP de ChirpStack (container 8080) -> host 127.0.0.1:8082 (para Caddy)
      - "127.0.0.1:8082:8080"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["lorawan", "sim", "bridge", "obs"]

  chirpstack-rest-api:
    image: chirpstack/chirpstack-rest-api:4
    restart: unless-stopped
    command:
      - --server
      - chirpstack:8080
      - --bind
      - 0.0.0.0:8090
      - --insecure
    depends_on:
      chirpstack:
        condition: service_started
    ports:
      - "127.0.0.1:8090:8090"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["lorawan", "sim", "bridge", "obs"]

  chirpstack-gateway-bridge-us915-0:
    image: chirpstack/chirpstack-gateway-bridge:4
    restart: unless-stopped
    command: ["-c", "/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml"]
    volumes:
      - ./chirpstack/configuration/gateway-bridge/us915_0.toml:/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml:ro
    depends_on:
      mosquitto:
        condition: service_healthy
    ports:
      - "1700:1700/udp"
      - "127.0.0.1:9100:9100"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["lorawan", "sim", "bridge", "obs"]

  chirpstack-gateway-bridge-eu868:
    image: chirpstack/chirpstack-gateway-bridge:4
    restart: unless-stopped
    command: ["-c", "/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml"]
    volumes:
      - ./chirpstack/configuration/gateway-bridge/eu868.toml:/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml:ro
    depends_on:
      mosquitto:
        condition: service_healthy
    ports:
      - "1701:1700/udp"
      - "127.0.0.1:9101:9100"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["lorawan", "sim", "bridge", "obs"]

  chirpstack-gateway-bridge-au915-0:
    image: chirpstack/chirpstack-gateway-bridge:4
    restart: unless-stopped
    command: ["-c", "/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml"]
    volumes:
      - ./chirpstack/configuration/gateway-bridge/au915_0.toml:/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml:ro
    depends_on:
      mosquitto:
        condition: service_healthy
    ports:
      - "1702:1700/udp"
      - "127.0.0.1:9102:9100"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["lorawan", "sim", "bridge", "obs"]

  # AS923_4 -> 1703/udp (mapeado a 1700 dentro del contenedor)
  chirpstack-gateway-bridge-as923-4:
    image: chirpstack/chirpstack-gateway-bridge:4
    restart: unless-stopped
    command: ["-c", "/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml"]
    volumes:
      - ./chirpstack/configuration/gateway-bridge/as923_4.toml:/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml:ro
    depends_on:
      mosquitto:
        condition: service_healthy
    ports:
      - "1703:1700/udp"
      - "127.0.0.1:9103:9100"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["lorawan", "sim", "bridge", "obs"]

  lorawan-modbus-bridge:
    build:
      context: ./lorawan-modbus-bridge
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - MQTT_BROKER=tcp://mosquitto:1883
      # Por defecto solo loguea y NO escribe a Modbus hasta que definas MODBUS_WRITE_URL:
      # Ej: http://modbus-server:8080/write?unit=1&addr=1&value=123
      - MODBUS_WRITE_URL=
      # Topic(s) MQTT: doc oficial sugiere application/APPLICATION_ID/device/+/event/up
      - MQTT_SUB_TOPIC=application/+/device/+/event/up
    depends_on:
      mosquitto:
        condition: service_healthy
      modbus-server:
        condition: service_started
      chirpstack:
        condition: service_started
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["bridge"]

  chirpstack-simulator:
    build:
      context: ./simulator
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      chirpstack:
        condition: service_started
      mosquitto:
        condition: service_healthy
    volumes:
      - ./simulator/chirpstack-simulator.toml:/etc/chirpstack-simulator.toml:ro
    command: ["-c", "/etc/chirpstack-simulator.toml"]
    ports:
      - "127.0.0.1:9000:9000"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - pruebatcp1
    profiles: ["sim"]

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    restart: unless-stopped
    ports:
      - "127.0.0.1:8089:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    privileged: true
    networks:
      - pruebatcp1
    profiles: ["obs"]

  prometheus:
    image: prom/prometheus:v2.55.1
    restart: unless-stopped
    ports:
      - "127.0.0.1:9091:9090"
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    networks:
      - pruebatcp1
    profiles: ["obs"]

  grafana:
    image: grafana/grafana:11.3.0
    restart: unless-stopped
    ports:
      - "127.0.0.1:3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - pruebatcp1
    profiles: ["obs"]

networks:
  pruebatcp1:
    driver: bridge

volumes:
  chirpstack-postgresql-data:
  chirpstack-redis-data:
  prometheus_data:
  grafana_data: